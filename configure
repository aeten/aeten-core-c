#!/bin/bash

set -e

CURDIR=$(readlink -f $(dirname "${0}"))
AETEN_MAKE=${CURDIR}/cots/aeten-make
AETEN_CLI_DIR=${CURDIR}/cots/aeten-cli
AETEN_CLI=${AETEN_CLI_DIR}/aeten-cli.sh

# If git repository
DESCRIPTION=$(git describe --long --dirty=-* --all --always 2>/dev/null)
if [ -n "${DESCRIPTION}" ]; then
	PROJECT_NAME=$(basename "$(realpath "${CURDIR}")")
	TAG=$(git describe --tags 2>/dev/null; true)
	DESCRIPTION=${DESCRIPTION/*\//}
	: ${TAG:=0}
	: ${DESCRIPTION:=0}
	cat - > .description <<EOF
project: ${PROJECT_NAME}
tag: ${TAG}
description: ${DESCRIPTION}
EOF
# Not a git repository
else
	PROJECT_NAME=$(sed -n 's/^project: //p' .description)
	TAG=$(sed -n 's/^tag: //p' .description)
	DESCRIPTION=$(sed -n 's/^description: //p' .description)
fi

$(${AETEN_CLI_DIR}/aeten-ads init - -- "${@}" << EOF
#NAME: $(basename ${0})
#TITLE:  ${PROJECT_NAME^^} $(basename ${0}) manual
#VERSION: ${TAG}
#SHORT_DESCRIPTION: Ã†ten core library building configuration script.
#DESCRIPTION: Configures and generates building file (Ninja or GNU Make).
prefix <prefix-path>: The prefix path for installation, _/usr/local_ by default.
src <directory>: The sources directory
test <directory>: The sources directory for tests
out <directory>: The output build directory, _${CURDIR}/build_ by default.
conf <config-file>: The configuration bash file path to source, _config.sh_ by default.
plantuml <jar-file>: The PlantUML jar file path.
object-model|M <model>: The object model generation mode, _simple_ support only one parent per interface whereas _complete_ support several and provides castable ojects (ie. cast a list to iterable).
generic-replacement|R <replacement>: The parameterized type replacement, _void\*_ by default (may be _aeten\\_Object\*_ for example).
gcc <gcc-exec-file>: The GCC executable file path.
warning <list>: The warning flags to activate, _all_ and _error_ by default.
qtcreator: Create QtCreator project target
verbose: Verbose build output.
version|V: Shows ${PROJECT_NAME} version.
EOF
)

: ${PREFIX:=/usr/local}
: ${WARNING:=error}
: ${CONFIG:=${CURDIR}/config.sh}
: ${SRC:=src}
: ${TEST:=test}
: ${OUT:=build}
: ${GENERIC_REPLACEMENT:=void*}
: ${VERSION:=false}
: ${VERBOSE:=false}
: ${QTCREATOR:=false}
: ${GEN_DIR:=${OUT}/generated}
SRC=$(readlink -m "${CURDIR}/${SRC}")
TEST=$(readlink -m "${CURDIR}/${TEST}")
OUT=$(readlink -m "${CURDIR}/${OUT}")
SRC_DIR=${SRC/${CURDIR}\//}
TEST=${TEST/${CURDIR}\//}
OUT=${OUT/${CURDIR}\//}
CURDIR=$(dirname "${0}")

if [ ${VERBOSE} = true ]; then
	VERBOSE=-v
else
	VERBOSE=
fi

IQUOTES="${SRC_DIR} ${SRC_DIR}/aeten ${GEN_DIR}/${SRC_DIR} ${GEN_DIR}/${SRC_DIR}/aeten ${GEN_DIR}/${TEST} ${GEN_DIR}/${TEST_DIR}/aeten"
LDFLAGS+='-lpthread'

${VERSION} && { echo ${PROJECT_NAME}: version ${TAG}; exit 0; }

[ -f "${CONFIG}" ] && . "${CONFIG}"

INSTALL_LIB_DIR="${PREFIX}/lib"
INSTALL_BIN_DIR="${PREFIX}/bin"

$(${AETEN_CLI} import check inform fatal confirm query)

BUILDER=ninja
: ${PREFIX:=$(query 'Enter the prefix installation path.')}
: ${PLANTUML:=$(query 'Enter the plantuml jar path.')}

TEMPLATE=template.ninja
case "${BUILDER}" in
	ninja)
		template=${TEMPLATE}
		build_script=build.ninja;;
	make)
		template=build.mk
		build_script=makefile
		check -m 'Generates GNU Make template' "${AETEN_MAKE}/ninja2make ${CURDIR}/${TEMPLATE}|sed 's,@@check@@,./${AETEN_CLI} check ${VERBOSE},g' > ${CURDIR}/${template}";;
	*) fatal 'Builder must be "ninja" or "make"';;
esac

add_prefix="${AETEN_MAKE}/generate-builder add-prefix"
add_suffix="${AETEN_MAKE}/generate-builder add-suffix"
replace_suffix="${AETEN_MAKE}/generate-builder replace-suffix"
replace_prefix="${AETEN_MAKE}/generate-builder replace-prefix"
target="${AETEN_MAKE}/generate-builder target --builder ${BUILDER}"

# Submodules setup
if [ -n "${DESCRIPTION}" ]; then
	SUBMODULES=$(git submodule status|awk '{print $$2}')
	SUBMODULES_SCRIPT=cots/aeten-git-tools/aeten-submodules.sh
	git_submodule=". ${AETEN_CLI} && aeten_cli_import ${AETEN_CLI} all && . ./${SUBMODULES_SCRIPT} && git-submodule-"

	if [ -f "${AETEN_CLI}" ]; then
		for module in ${SUBMODULES}; do
			(${git_submodule}-check ${module}>/dev/null)
		done
	else
		git submodule init ${AETEN_CLI_DIR}
	fi
fi

get-puml-include() {
	local _src="${1}"
	local _inc
	local _puml
	local _dir
	for _inc in $(sed -n 's/^!include \([^!]\+\)/\1/p' "${_src}"); do
		for _dir in $(dirname ${_src}) $(${replace_prefix} ${TEST}/ ${SRC_DIR}/ $(dirname ${_src})) ${IQUOTES}; do
			_puml="${_dir}/${_inc}"
			[ -f "${_puml}" ] && { echo "${_puml}"; get-puml-include "${_puml}"; break; }
			_puml=${_puml/.c/.puml}
			[ -f "${_puml}" ] && { echo "${_puml}"; get-puml-include "${_puml}"; break; }
		done
	done
}

get-headers() {
	local source_file="$1"; shift
	local source_dir=$(dirname "${source_file}")
	local iquotes=$(${add_prefix} -iquote\  $(echo ${@}) ${GEN_DIR}/${source_dir/test\//src\/} ${GEN_DIR}/${source_dir})
	inform "Resolving headers needed by ${source_file}" >&2
	gcc -MM ${iquotes} "${source_file}" | sed '1 s,.\+: '"${source_file//./\\.}"',,; s/\\$//'
}

build-target() {
	local command=$1; shift
	local in_prefix=$1; shift
	local in_suffix=$1; shift
	local out_prefix=$1; shift
	local out_suffix=$1; shift
	local output
	inform "Building target for ${command} command from ${in_suffix}" >&2
	for input in $@; do
		output=" ${out_prefix}$(dirname ${input}|sed 's,^\\\${output}/,,')/$(basename --suffix=.${in_suffix} ${input}).${out_suffix}"
		${target} --command ${command} --depends ${input} ${output}
	done
}

COMMANDS=$(. ${AETEN_CLI} && __aeten_cli_api ${AETEN_CLI} | grep -v '^import$')
LINKS=$(${add_prefix} ${INSTALL_BIN_DIR}/ ${COMMANDS})
SRC=$(find ${SRC_DIR}/ ${TEST}/ -type f -name \*.c)
PUML=$(find ${SRC_DIR}/ ${TEST}/ -type f -name \*.puml)
OBJ=$(       ${replace_suffix} .c .o   $(${add_prefix} \\\\\${output}/    ${SRC}))
HEADERS=$(   ${replace_suffix} .c .h   $(${add_prefix} \\\\\${generated}/ ${SRC}))
XMI_FILES=$( ${replace_suffix} .c .xmi $(${add_prefix} \\\\\${output}/    ${SRC}) $(${add_prefix} \\\\\${output}/ $(${replace_suffix} .puml .xmi ${PUML})))
PUML_PATH="-Dplantuml.include.path=${SRC_DIR}:${SRC_DIR}/aeten:${GEN_DIR}/${SRC_DIR}:${GEN_DIR}/${SRC_DIR}/aeten"
PUML_FLAGS=$(${add_suffix} "='${GENERIC_REPLACEMENT}'" $(${add_prefix} -D {A..Z}))

BUILD_TARGETS=$( (
	build-target xmi2c       ${SRC_DIR}/ xmi  '\\\${generated}/' '{h,c}' ${XMI_FILES};

	for _src in ${SRC} ${PUML}; do
		inform "Building target for puml2xmi command from ${_src}" >&2
		${target} --command puml2xmi --depends ${_src} $(${add_prefix} '--depends \\\${output}/' $(${replace_suffix} .puml .xmi $(${replace_suffix} .c .xmi $(get-puml-include ${_src})))) '\\\${output}/'$(dirname ${_src})/$(basename $(basename ${_src} .c) .puml).xmi
	done

	for _src in $(find ${SRC_DIR} ${TEST} -name \*.c); do
		_deps=$(${add_prefix} '--depends \\\${generated}/' $(dirname ${_src})/$(basename --suffix=.c ${_src}).h $(${replace_suffix} .c .h $(get-puml-include ${_src})))
		inform "Building target objdep from ${_src}" >&2
		${target} --command objdep --depends ${_src} ${_deps} '\\\${output}/'$(${replace_suffix} .c .o ${_src}).d
		inform "Building target cc from ${_src}" >&2
		_out='\\\${output}/'$(${replace_suffix} .c '.o' ${_src})
		${target} --command cc --depends ${_src} --depends '| '${_out}.d ${_out}
	done

	for _src in $(find ${TEST} -name \*.c); do
		executable=$(basename ${_src//_/-} .c);
		depedencies="$(${replace_suffix} .c .o ${_src}) "
		inform "Building target bindep from ${_src}" >&2
		${target} --command bindep --depends '\\\${output}/'$(${replace_suffix} .c .o ${_src}).d --depends ${_src} '\\\${output}/test/'${executable}.d
		inform "Building target ld from ${_src}" >&2
		_out='\\\${output}/test/'${executable}
		${target} --command ld --depends '\\\${output}/'$(${replace_suffix} .c .o ${_src}) --depends '| '${_out}.d ${_out}
		inform "Building target run from ${_src}" >&2
		${target} --command run --depends '\\\${output}/test/'${executable} run-${executable};
	done
) |sed '$ ! s/$/\\/')

RUN_TESTS="$(for src in $(find ${TEST} -name \*.c); do
	echo run-$(basename ${src//_/-} .c);
done|paste -sd' ' -)"

check -m "Generates ${build_script}" ${AETEN_MAKE}/generate-builder -t ${CURDIR}/${template} "${@}" '>' ${CURDIR}/${build_script} <<EOF
PROJECT         = ${PWD##*/}
BUILDER         = ${BUILDER}
CFLAGS          = ${CFLAGS} $(${add_prefix} -W ${WARNING}) $(${add_prefix} -iquote\  ${IQUOTES})
LDFLAGS         = ${LDFLAGS}
PUML_PATH       = ${PUML_PATH}
PUML_FLAGS      = ${PUML_FLAGS}
JAVA            = java
PLANTUML        = ${PLANTUML}
XMI2C           = $(dirname "$0")/xmi2c
CC              = gcc
LD              = gcc
INSTALL_LIB_DIR = ${LIB_DIR}
OBJ             = $(echo ${OBJ})
BUILD_TARGETS   = ${BUILD_TARGETS}
RUN_TESTS       = ${RUN_TESTS}
OUT             = ${OUT}
GENERATED       = ${GEN_DIR}
SRC             = $(echo ${SRC}|tr ' ' ':')
IPATH           = ${IQUOTES// /:}
API             = $(${add_prefix} '\\\${generated}/' $(${replace_suffix} .c .h ${SRC}))
EOF

if [ ${BUILDER} = make ]; then
	rm ${template}
else
	exit 0
fi

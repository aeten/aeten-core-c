#!/bin/bash

set -e

CURDIR=$(dirname "${0}")
AETEN_MAKE=${CURDIR}/cots/aeten-make
AETEN_CLI_DIR=${CURDIR}/cots/aeten-cli
AETEN_CLI=${AETEN_CLI_DIR}/aeten-cli.sh

# If git repository
DESCRIPTION=$(git describe --long --dirty=-* --all --always 2>/dev/null)
if [ -n "${DESCRIPTION}" ]; then
	PROJECT_NAME=$(basename "$(realpath "${CURDIR}")")
	TAG=$(git describe --tags 2>/dev/null; true)
	DESCRIPTION=${DESCRIPTION/*\//}
	: ${TAG:=0}
	: ${DESCRIPTION:=0}
	cat - > .description <<EOF
project: ${PROJECT_NAME}
tag: ${TAG}
description: ${DESCRIPTION}
EOF
# Not a git repository
else
	PROJECT_NAME=$(sed -n 's/^project: //p' .description)
	TAG=$(sed -n 's/^tag: //p' .description)
	DESCRIPTION=$(sed -n 's/^description: //p' .description)
fi

$(${AETEN_CLI_DIR}/aeten-ads init - -- "${@}" << EOF
#NAME: $(basename ${0})
#TITLE:  ${PROJECT_NAME^^} $(basename ${0}) manual
#VERSION: ${TAG}
#SHORT_DESCRIPTION: Ã†ten core library building configuration script.
#DESCRIPTION: Configures and generates building file (Ninja or GNU Make).
builder <builder>: The target builder tool, _ninja_ or _make_.
prefix <prefix-path>: The prefix path for installation, _/usr/local_ by default.
out <directory>: The output build directory, _${CURDIR}/build_ by default.
conf <config-file>: The configuration bash file path to source, _config.sh_ by default.
plantuml <jar-file>: The PlantUML jar file path.
object-model|M <model>: The object model generation mode, _simple_ support only one parent per interface whereas _complete_ support several and provides castable ojects (ie. cast a list to iterable).
generic-replacement|R <replacement>: The parameterized type replacement, _aeten\\_\\_Object\*_ by default (may be _void\*_ for example).
gcc <gcc-exec-file>: The GCC executable file path.
warning <list>: The warning flags to activate, _all_ and _error_ by default.
verbose: Verbose build output.
version|V: Shows ${PROJECT_NAME} version.
EOF
)

: ${PREFIX:=/usr/local}
: ${WARNING:=error}
: ${CONFIG:=${CURDIR}/config.sh}
: ${OUT:=${CURDIR}/build}
: ${GENERIC_REPLACEMENT:=aeten__Object*}
: ${VERSION:=false}
: ${VERBOSE:=false}
if [ ${VERBOSE} = true ]; then
	VERBOSE=-v
else
	VERBOSE=
fi

IQUOTES='src/ generated/interface/uml/ test/'
LDFLAGS+='-lpthread'

${VERSION} && { echo ${PROJECT_NAME}: version ${TAG}; exit 0; }

[ -f "${CONFIG}" ] && . "${CONFIG}"

INSTALL_LIB_DIR="${PREFIX}/lib"
INSTALL_BIN_DIR="${PREFIX}/bin"

$(${AETEN_CLI} import check fatal confirm query)

: ${BUILDER:=$(confirm --no 'Use Ninja instead of GNU Make?' && echo ninja || echo make)}
: ${PREFIX:=$(query 'Enter the prefix installation path.')}
: ${PLANTUML:=$(query 'Enter the plantuml jar path.')}

TEMPLATE=build-template.ninja
case "${BUILDER}" in
	ninja)
		template=${TEMPLATE}
		build_script=build.ninja;;
	make)
		template=build.mk
		build_script=makefile
		check -m 'Generates GNU Make template' "${AETEN_MAKE}/ninja2make ${CURDIR}/${TEMPLATE}|sed 's,@@check@@,./${AETEN_CLI} check ${VERBOSE},g' > ${CURDIR}/${template}";;
	*) fatal 'Builder must be "ninja" or "make"';;
esac

check="${AETEN_CLI} check"
add_prefix="${AETEN_MAKE}/generate-builder add-prefix"
add_suffix="${AETEN_MAKE}/generate-builder add-suffix"
replace_suffix="${AETEN_MAKE}/generate-builder replace-suffix"
target="${AETEN_MAKE}/generate-builder target --builder ${BUILDER}"

# Submodules setup
if [ -n "${DESCRIPTION}" ]; then
	SUBMODULES=$(git submodule status|awk '{print $$2}')
	SUBMODULES_SCRIPT=cots/aeten-git-tools/aeten-submodules.sh
	git_submodule=". ${AETEN_CLI} && aeten_cli_import ${AETEN_CLI} all && . ./${SUBMODULES_SCRIPT} && git-submodule-"

	if [ -f "${AETEN_CLI}" ]; then
		for module in ${SUBMODULES}; do
			(${git_submodule}-check ${module}>/dev/null)
		done
	else
		git submodule init ${AETEN_CLI_DIR}
	fi
fi

get-headers() {
	local source_file="$1"; shift
	local iquotes=$(${add_prefix} -iquote\  ${@})
	gcc -MM ${iquotes} "${source_file}" | sed '1 s,.\+: '"${source_file//./\\.}"',,; s/\\$//'
}

build-target() {
	local command=$1; shift
	local in_prefix=$1; shift
	local in_suffix=$1; shift
	local out_prefix=$1; shift
	local out_suffix=$1; shift
	local output
	for input in $@; do
		output=${out_prefix}$(dirname $input|sed 's,^\\\${output}/,,')
		${target} --command $command --depends $input ${output}/$(basename --suffix=.$in_suffix $input).$out_suffix
	done
}

COMMANDS=$(. ${AETEN_CLI} && __aeten_cli_api ${AETEN_CLI} | grep -v '^import$')
LINKS=$(${add_prefix} ${INSTALL_BIN_DIR}/ ${COMMANDS})
SRC=$(find src/ test/ -type f -name \*.c)
OBJ=$(${replace_suffix} .c .o $(${add_prefix} \\\\\${output}/ ${SRC}))
PUML_FILES=$(find uml -type f -name \*.puml)
HEADERS=$(${replace_suffix} .puml .h $(${add_prefix} \\\\\${output}/ ${PUML_FILES}))
XMI_FILES=$(${replace_suffix} .h .xmi ${HEADERS})
PUML_PATH="-Dplantuml.include.path=uml:uml/aeten"
PUML_FLAGS=$(${add_suffix} "=${GENERIC_REPLACEMENT}" $(${add_prefix} -D {A..Z}))

BUILD_TARGETS=$( (
	build-target puml2xmi ''   puml '\${output}/' xmi ${PUML_FILES};
	build-target xmi2c    uml/ xmi  '\${generated}/interface/' h ${XMI_FILES};
	build-target xmi2c    uml/ xmi  '\${generated}/skeleton/' c ${XMI_FILES};
	build-target cc       ''   c    '\${output}/' o ${SRC}
	for ut_src in $(find test -name \*.c); do
		ut=$(basename ${ut_src//_/-} .c);
		depedencies=$(for header in $(get-headers ${ut_src} ${IQUOTES}); do
			test -f "$(${replace_suffix} .h .c ${header/generated\/interface\/uml\//src/})" && echo "$(${replace_suffix} .h .o ${header/generated\/interface\/uml\//src/})"
			test -f "$(${replace_suffix} .h .c ${header/generated\/interface\/uml\//test/})" && echo "$(${replace_suffix} .h .o ${header/generated\/interface\/uml\//test/})"
		done|uniq);
		${target} --command ld $(${add_prefix} '--depends \\\${output}/' $(echo $(${replace_suffix} .c .o ${ut_src}) ${depedencies}|tr ' ' '\n'|uniq)) \\\${output}/test/${ut};
		${target} --command run --depends \\\${output}/test/${ut} run-${ut};
	done
) |sed '$ ! s/$/\\/')

RUN_TESTS="$(for ut_src in $(find test -name \*.c); do
	echo run-$(basename ${ut_src//_/-} .c);
done|paste -sd' ' -)"

check -m "Generates ${build_script}" -v ${AETEN_MAKE}/generate-builder -t ${CURDIR}/${template} "${@}" '>' ${CURDIR}/${build_script} <<EOF
BUILDER         = ${BUILDER}
CFLAGS          = ${CFLAGS} $(${add_prefix} -W ${WARNING}) $(${add_prefix} -iquote\  ${IQUOTES})
LDFLAGS         = ${LDFLAGS}
PUML_PATH       = ${PUML_PATH}
PUML_FLAGS      = ${PUML_FLAGS}
JAVA            = java
PLANTUML        = ${PLANTUML}
XMI2C           = $(dirname "$0")/xmi2c
CC              = gcc
LD              = gcc
INSTALL_LIB_DIR = ${LIB_DIR}
OBJ             = $(echo ${OBJ})
BUILD_TARGETS   = ${BUILD_TARGETS}
RUN_TESTS       = ${RUN_TESTS}
OUT             = ${OUT}
GENERATED       = ${CURDIR}/generated
API             = $(${add_prefix} '\\\${generated}/interface/' $(${replace_suffix} .puml .h ${PUML_FILES}))
EOF

if [ ${BUILDER} = make ]; then
	rm ${template}
else
	exit 0
fi
